# Maintainer: Sven-Hendrik Haase <sh@lutzhaase.com>
# Contributor: Stephen Zhang <zsrkmyn at gmail dot com>
# Update by Mamy Andr√©-Ratsimbazafy <Github mratsim>
# For Magma, MKLDNN, MKL, CUDNN, OpenCV (for video input)

pkgname=("python-pytorch-magma-mkldnn-cudnn-git")
_pkgname="pytorch"
pkgver=v1.0rc0.r5274.g6f0f7e316d
pkgrel=1
pkgdesc="Tensors and Dynamic neural networks in Python with strong GPU acceleration"
arch=('x86_64')
url="https://pytorch.org"
license=('BSD')
depends=('python' 'python-yaml' 'python-numpy' 'opencv' 'intel-mkl' 'intel-mpi' 'mkl-dnn' 'cuda' 'cudnn' 'magma' 'nccl' 'cub')
makedepends=('python-setuptools' 'cmake' 'git' 'intel-compiler-base')
provides=('python-pytorch' 'python-pytorch-cuda')
conflicts=('python-pytorch' 'python-pytorch-cuda')
source=("git+https://github.com/pytorch/pytorch.git")
sha256sums=('SKIP')

pkgver() {
  cd "${_pkgname}"
  git describe --long --tags | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd "${_pkgname}"

  git submodule update --init --recursive
}

build() {
  export USE_OPENCV=ON 
  export USE_FFMPEG=ON
  export USE_MKLDNN=ON
  export USE_OPENMP=ON
  export USE_NNPACK=ON # A bit redundant with MKLDNN hopefully PyTorch choose the best depending on op
  export USE_CUDA=ON
  export USE_CUDNN=ON
  export USE_NCCL=ON
  export USE_SYSTEM_NCCL=ON
  export USE_OPENCL=OFF
  export USE_ROCM=OFF
  export USE_OPENMP=ON
  export USE_NUMPY=ON
  export USE_MAGMA=ON
  export USE_NATIVE_ARCH=ON
  
  export CC=gcc-8
  export CXX=g++-8
  export CUDAHOSTCXX=g++-8
  export CUDA_HOME=/opt/cuda
  export CUDNN_LIB_DIR=/usr/lib
  export CUDNN_INCLUDE_DIR=/usr/include
  export TORCH_CUDA_ARCH_LIST="7.5" # Consumer Turing
  export MAGMA_HOME=/opt/magma 
  export OPENCV_INCLUDE_DIRS=/usr/include/opencv4
  export FFMPEG_INCLUDE_DIR=/usr/include # libavcodec, libavutils
  export FFMPEG_LIBRARIES=/usr/lib # libavcodec
  export CUB_INCLUDE_DIRS=/usr/include # For system CUB, otherwise PyTorch picks it from thirdparty submodules

  # Link to Intel OpenMP like MKL-DNN
  # https://github.com/pytorch/pytorch/issues/12535
  export OpenMP_C_FLAGS="-liomp5"
  export OpenMP_CXX_FLAGS="-liomp5"
  export OpenMP_C_LIB_NAMES="iomp5"
  export OpenMP_CXX_LIB_NAMES="iomp5"
  export CMAKE_EXE_LINKER_FLAGS="-liomp5"

  source /opt/intel/mkl/bin/mklvars.sh intel64
  source /opt/intel/pkg_bin/compilervars.sh intel64
  
  # Python flags  
  export NO_CUDA=0
  export WITH_CUDNN=1


  cd "$srcdir/${_pkgname}"
  python setup.py build
}

package() {
  cd "$srcdir/${_pkgname}"
  python setup.py install --root="$pkgdir"/ --optimize=1 --skip-build
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE.txt"
  
  msg2 "Pytorch has been build against Intel MPI, make sure to add '/opt/intel/composerxe/linux/mpi/intel64/libfabric/lib/' to /etc/ld.so.conf.d/intel-mpi.conf"
  msg2 "If OpenCV is built against Intel Parallel Studio, PyTorch will link against intel-tbb_psxe. The current one specifies a wrong path '/opt/intel/composerxe/tbb/lib/intel64/gcc4.7' in /etc/ld.so.conf.d/intel-tbb.conf, it should be either '/opt/intel/tbb/lib/intel64/gcc4.7' or '/opt/intel/composerxe/linux/tbb/lib/intel64/gcc4.7'"
}

# vim:set ts=2 sw=2 et:
